<app-student-navbar></app-student-navbar>

<div class="container py-4" *ngIf="course">
  <div class="row g-4">
    <!-- LEFT: Video + Tabs -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <!-- Video -->
          <div class="player-wrap bg-dark position-relative">
            <video #videoRef class="w-100" controls [poster]="'http://localhost:8080/' + course.thumbnail"
                   (ended)="onVideoEnded()" (timeupdate)="onTimeUpdate()">
              <source [src]="'http://localhost:8080/' + course.videoUrl" type="video/mp4" />
              Your browser does not support the video tag.
            </video>

            <!-- small overlay: duration / quality / mini-info -->
            <div class="video-meta position-absolute top-0 end-0 m-3 text-white small">
              <span class="badge bg-dark bg-opacity-50"> {{ course.durationHrs }} hrs</span>
            </div>
          </div>

          <!-- Tab nav below video -->
          <nav class="nav nav-pills gap-2 p-3 border-top">
            <a class="nav-link" [ngClass]="{ active: currentTab === 'overview' }" (click)="setTab('overview')">Overview</a>
            <a class="nav-link" [ngClass]="{ active: currentTab === 'notes' }" (click)="setTab('notes')">Notes</a>
            <a class="nav-link" [ngClass]="{ active: currentTab === 'reviews' }" (click)="setTab('reviews')">Reviews</a>
            <a class="nav-link" [ngClass]="{ active: currentTab === 'assessments' }" (click)="setTab('assessments')">Assessments</a>
            <a class="nav-link" [ngClass]="{ active: currentTab === 'announcements' }" (click)="setTab('announcements')">Announcements</a>
            <div class="ms-auto small text-muted align-self-center">
              <span *ngIf="enrollment">Progress: {{ enrollment.progress || 0 }}%</span>
            </div>
          </nav>

          <!-- Tab content -->
          <div class="p-3">
            <!-- OVERVIEW -->
            <div *ngIf="currentTab === 'overview'">
              <h4 class="mb-1">{{ course.title }}</h4>
              <div class="small text-muted mb-2">{{ course.domain }} • {{ course.level }}</div>
              <p class="mb-3">{{ course.description }}</p>

              <!-- Compact progress -->
              <div class="mb-3">
                <div class="d-flex align-items-center gap-3">
                  <div class="flex-grow-1">
                    <div class="progress" style="height: 10px;">
                      <div class="progress-bar" role="progressbar" [style.width.%]="enrollment?.progress || 0">
                      </div>
                    </div>
                  </div>
                  <div class="small text-muted">{{ enrollment?.progress || 0 }}%</div>
                </div>
              </div>

              <!-- Quick actions -->
              <div class="d-flex gap-2">
                <button class="btn btn-primary" (click)="togglePlay()" title="Play/Pause video">
                  <i class="bi bi-play-fill"></i> Play
                </button>

                <button class="btn btn-outline-primary" (click)="markDoneClicked()" [disabled]="!isWatched || isDone">
                  <i class="bi bi-check2-circle"></i>
                  {{ isDone ? 'Completed' : 'Mark as done' }}
                </button>

                <div class="ms-auto d-flex align-items-center gap-2">
                  <div class="small text-muted me-2">Your rating:</div>
                  <div>
                    <ng-container *ngFor="let s of [1,2,3,4,5]">
                      <i class="bi"
                         [ngClass]="(currentRating || 0) >= s ? 'bi-star-fill text-warning' : 'bi-star'"
                         (click)="onStarClick(s)"
                         [style.cursor]="isDone ? 'pointer' : 'not-allowed'"
                         [attr.title]="isDone ? 'Rate ' + s + ' star' : 'Complete course to rate'"></i>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>

            <!-- NOTES -->
            <div *ngIf="currentTab === 'notes'">
              <h5>My Notes</h5>
              <textarea [(ngModel)]="notesText" class="form-control mb-2" rows="7" placeholder="Write notes for yourself..."></textarea>
              <div class="d-flex gap-2">
                <button class="btn btn-success" (click)="saveNotes()">Save Notes</button>
                <button class="btn btn-outline-secondary" (click)="clearNotes()">Clear</button>
                <small class="text-muted ms-auto align-self-center">Notes auto-saved locally</small>
              </div>
            </div>

            <!-- REVIEWS -->
            <div *ngIf="currentTab === 'reviews'">
              <h5>Reviews & Ratings</h5>
              <div class="d-flex align-items-center gap-3 mb-3">
                <div class="display-6 fw-bold">{{ course.avgRating ?? '—' }}</div>
                <div>
                  <div class="small text-muted">Average rating</div>
                  <div class="small text-muted">{{ course.studentsCount || 0 }} students</div>
                </div>
              </div>

              <div *ngIf="reviews.length; else noReviews">
                <div *ngFor="let r of reviews" class="border rounded p-3 mb-2">
                  <div class="d-flex justify-content-between">
                    <div><strong>{{ r.user || 'Student' }}</strong></div>
                    <div class="small text-muted">{{ r.date | date:'short' }}</div>
                  </div>
                  <div class="mt-1">
                    <ng-container *ngFor="let s of [1,2,3,4,5]">
                      <i class="bi" [ngClass]="s <= r.rating ? 'bi-star-fill text-warning' : 'bi-star'"></i>
                    </ng-container>
                  </div>
                  <p class="mb-0 mt-2">{{ r.comment }}</p>
                </div>
              </div>
              <ng-template #noReviews>
                <div class="text-muted">No reviews yet. Be the first to rate after completing the course.</div>
              </ng-template>
            </div>

            <!-- ASSESSMENTS -->
            <div *ngIf="currentTab === 'assessments'">
              <h5>Assessments</h5>
              <div *ngIf="assessments?.length; else noAssess">
                <div *ngFor="let a of assessments" class="d-flex align-items-center justify-content-between border rounded p-3 mb-2">
                  <div>
                    <div class="fw-semibold">{{ a.title }}</div>
                    <div class="small text-muted">{{ a.description }}</div>
                  </div>
                  <div>
                    <a class="btn btn-primary btn-sm" [routerLink]="['/student/take-assessment', a.id]">Start</a>
                  </div>
                </div>
              </div>
              <ng-template #noAssess>
                <div class="text-muted">No assessments for this course.</div>
              </ng-template>
            </div>

            <!-- announcements content -->
            <div *ngIf="currentTab==='announcements'">
              <div *ngIf="announcements?.length; else noAnn">
                <div class="list-group">
                  <div class="list-group-item" *ngFor="let a of announcements">
                    <div class="d-flex justify-content-between">
                      <h6 class="mb-1">{{ a.title }}</h6>
                      <small class="text-muted">{{ a.createdAt | date:'medium' }}</small>
                    </div>
                    <p class="mb-1">{{ a.message }}</p>
                  </div>
                </div>
              </div>
              <ng-template #noAnn>
                <div class="alert alert-info">No announcements yet for this course.</div>
              </ng-template>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Sticky Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm sticky-card">
        <div class="card-body">
          <div class="d-flex gap-3">
            <img *ngIf="course.thumbnail" [src]="'http://localhost:8080/' + course.thumbnail" class="thumb" alt="thumb" />
            <div class="flex-grow-1">
              <div class="fw-semibold">{{ course.title }}</div>
              <div class="small text-muted">{{ course.domain }} • {{ course.level }}</div>
            </div>
          </div>

          <hr />

          <div class="mb-2">
            <div class="small text-muted">Your progress</div>
            <div class="d-flex align-items-center gap-2">
              <div class="flex-grow-1">
                <div class="progress" style="height: 10px;">
                  <div class="progress-bar" role="progressbar" [style.width.%]="enrollment?.progress || 0"></div>
                </div>
              </div>
              <div class="small text-muted">{{ enrollment?.progress || 0 }}%</div>
            </div>
          </div>

          <!-- <div class="mb-3">
            <button class="btn btn-success w-100" (click)="continueLearning()">Continue Learning</button>
          </div> -->

          <div class="mb-2 small text-muted">Course info</div>
          <ul class="list-unstyled small">
            <li><strong>{{ course.durationHrs }}h</strong> total length</li>
            <li>Level: {{ course.level }}</li>
          </ul>

          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-outline-secondary" (click)="downloadResources()" >Resources</button>
            <a class="btn btn-outline-primary" [routerLink]="['/student/courses']">Browse Courses</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
